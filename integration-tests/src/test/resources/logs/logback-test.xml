<?xml version="1.0" encoding="UTF-8"?>
<configuration scan="true" scanPeriod="30 seconds">

    <!-- Профиль для тестов -->
    <if condition='"test".equals(System.getProperty("spring.profiles.active"))'>
        <then>
            <!-- Консольный вывод для тестов -->
            <appender name="TEST_CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
                <encoder>
                    <pattern>%cyan(%d{HH:mm:ss.SSS}) %gray([%thread]) %highlight(%-5level) %magenta(%logger{36}) - %msg%n</pattern>
                </encoder>
            </appender>

            <!-- Файловый лог для тестов -->
            <appender name="TEST_FILE" class="ch.qos.logback.core.FileAppender">
                <file>${TEST_LOG_DIR:-target/test-logs}/integration-tests.log</file>
                <encoder>
                    <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</pattern>
                </encoder>
            </appender>

            <!-- Отдельный лог для Spring Integration -->
            <appender name="SI_FILE" class="ch.qos.logback.core.FileAppender">
                <file>${TEST_LOG_DIR:-target/test-logs}/spring-integration.log</file>
                <encoder>
                    <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</pattern>
                </encoder>
            </appender>

            <!-- Настройки уровней для тестов -->
            <root level="INFO">
                <appender-ref ref="TEST_CONSOLE"/>
                <appender-ref ref="TEST_FILE"/>
            </root>

            <logger name="org.springframework.integration" level="WARN" additivity="false">
                <appender-ref ref="SI_FILE"/>
            </logger>

            <logger name="com.example.tests" level="DEBUG"/>
        </then>
        <else>
            <!-- Оригинальная конфигурация для продакшена -->
            <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
            <include resource="org/springframework/boot/logging/logback/console-appender.xml"/>
        </else>
    </if>

    <!-- Общие настройки -->
    <timestamp key="bySecond" datePattern="yyyyMMdd'T'HHmmss"/>

    <contextListener class="ch.qos.logback.classic.jul.LevelChangePropagator">
        <resetJUL>true</resetJUL>
    </contextListener>
</configuration>